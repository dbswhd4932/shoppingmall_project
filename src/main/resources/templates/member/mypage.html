<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>마이페이지</title>
</head>
<body>
    <div layout:fragment="content">
        <h2 class="mb-4">마이페이지</h2>

        <!-- 회원 정보 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">내 정보</h5>
            </div>
            <div class="card-body">
                <div id="memberInfo">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="showEditForm()">정보 수정</button>
                    <button class="btn btn-danger" onclick="deleteMember()">회원 탈퇴</button>
                </div>
            </div>
        </div>

        <!-- 정보 수정 모달 -->
        <div class="modal fade" id="editModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">정보 수정</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editForm">
                            <div class="mb-3">
                                <label for="editName" class="form-label">이름</label>
                                <input type="text" class="form-control" id="editName" required>
                            </div>
                            <div class="mb-3">
                                <label for="editEmail" class="form-label">이메일</label>
                                <input type="email" class="form-control" id="editEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="editPhone" class="form-label">전화번호</label>
                                <input type="tel" class="form-control" id="editPhone" required>
                            </div>
                            <div class="mb-3">
                                <label for="editZipcode" class="form-label">우편번호</label>
                                <input type="text" class="form-control" id="editZipcode">
                            </div>
                            <div class="mb-3">
                                <label for="editDetailAddress" class="form-label">상세주소</label>
                                <input type="text" class="form-control" id="editDetailAddress">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="button" class="btn btn-primary" onclick="updateMember()">저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script layout:fragment="script">
        let editModal;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadMemberInfo();
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
        });

        // 회원 정보 조회
        async function loadMemberInfo() {
            try {
                const response = await axios.get('/api/members/me', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                    }
                });

                const member = response.data;
                document.getElementById('memberInfo').innerHTML = `
                    <table class="table">
                        <tbody>
                            <tr>
                                <th width="30%">아이디</th>
                                <td>${member.loginId}</td>
                            </tr>
                            <tr>
                                <th>이름</th>
                                <td>${member.name}</td>
                            </tr>
                            <tr>
                                <th>이메일</th>
                                <td>${member.email}</td>
                            </tr>
                            <tr>
                                <th>전화번호</th>
                                <td>${member.phone}</td>
                            </tr>
                            <tr>
                                <th>우편번호</th>
                                <td>${member.zipcode || '-'}</td>
                            </tr>
                            <tr>
                                <th>주소</th>
                                <td>${member.detailAddress || '-'}</td>
                            </tr>
                            <tr>
                                <th>회원 유형</th>
                                <td>${member.roles.map(r => r.roleType).join(', ')}</td>
                            </tr>
                        </tbody>
                    </table>
                `;

                // 수정 폼에 현재 정보 설정
                document.getElementById('editName').value = member.name;
                document.getElementById('editEmail').value = member.email;
                document.getElementById('editPhone').value = member.phone;
                document.getElementById('editZipcode').value = member.zipcode || '';
                document.getElementById('editDetailAddress').value = member.detailAddress || '';
            } catch (error) {
                console.error('회원 정보 조회 실패:', error);
                document.getElementById('memberInfo').innerHTML =
                    '<p class="text-danger">회원 정보를 불러오는데 실패했습니다.</p>';
            }
        }

        // 수정 폼 표시
        function showEditForm() {
            editModal.show();
        }

        // 회원 정보 수정
        async function updateMember() {
            const formData = {
                name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                zipcode: document.getElementById('editZipcode').value,
                detailAddress: document.getElementById('editDetailAddress').value
            };

            try {
                await axios.put('/api/members', formData, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                    }
                });

                alert('정보가 수정되었습니다.');
                editModal.hide();
                loadMemberInfo();
            } catch (error) {
                console.error('정보 수정 실패:', error);
                alert('정보 수정에 실패했습니다.');
            }
        }

        // 회원 탈퇴
        async function deleteMember() {
            if (!confirm('정말로 탈퇴하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                return;
            }

            try {
                await axios.delete('/api/members', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                    }
                });

                alert('회원 탈퇴가 완료되었습니다.');
                logout();
            } catch (error) {
                console.error('회원 탈퇴 실패:', error);
                alert('회원 탈퇴에 실패했습니다.');
            }
        }
    </script>
</body>
</html>
